<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–¢–µ—Å—Ç-—Ç—Ä–µ–Ω–∞–∂—ë—Ä (—Ç–µ–º—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root {
    --gap: 10px;
    --bg-color: #1e1e1e;
    --panel-color: #262626;
    --text-color: #eaeaea;
    --muted: #bdbdbd;
    --button-bg: #323232;
    --button-hover: #3c3c3c;
    --button-text: #ffffff;
    --accent: #6ba4ff;
    --border-color: #444;
  }
  .light {
    --bg-color: #ffffff;
    --panel-color: #f4f4f4;
    --text-color: #1e1e1e;
    --muted: #555;
    --button-bg: #e0e0e0;
    --button-hover: #d5d5d5;
    --button-text: #000;
    --accent: #0066cc;
    --border-color: #ccc;
  }
  body{
    font-family: system-ui, sans-serif;
    margin:20px;
    background:var(--bg-color);
    color:var(--text-color);
  }
  h2{margin:0 0 10px}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
  .panel{border:1px solid var(--border-color);border-radius:12px;padding:12px;background:var(--panel-color)}
  #question{white-space:pre-line;font-weight:600;margin:10px 0}
  #answerInput{width:100%;min-height:110px;padding:10px;font-size:16px;background:var(--panel-color);color:var(--text-color);border:1px solid var(--border-color);border-radius:8px}
  button{padding:8px 12px;border:none;border-radius:10px;cursor:pointer;background:var(--button-bg);color:var(--button-text)}
  button:hover:not(:disabled){background:var(--button-hover)}
  button:disabled{opacity:.45;cursor:not-allowed}
  .pill{padding:4px 8px;border-radius:999px;background:var(--panel-color);color:var(--muted);border:1px solid var(--border-color)}
  .spacer{height:8px}
  #correctBox{white-space:pre-line;padding:10px;background:var(--panel-color);border:1px solid var(--border-color);border-radius:8px;color:var(--accent);display:none}
  select{background:var(--panel-color);color:var(--text-color);border:1px solid var(--border-color);border-radius:8px;padding:6px}
  #themeToggle{margin-left:auto}
</style>
</head>
<body>

<div class="row">
  <h2>–¢–µ—Å—Ç-—Ç—Ä–µ–Ω–∞–∂—ë—Ä</h2>
  <button id="themeToggle">üåô/‚òÄÔ∏è</button>
</div>

<div class="panel row">
  <label>–¢–µ–º–∞:
    <select id="topicSelect"></select>
  </label>
</div>

<div class="spacer"></div>

<div class="panel row">
  <label>–°: <input id="rangeStart" type="number" min="1" value="1"></label>
  <label>–ü–æ: <input id="rangeEnd" type="number" min="1" value="1"></label>
  <label><input id="shuffle" type="checkbox"> –ü–µ—Ä–µ–º–µ—à–∞—Ç—å</label>
  <button id="startBtn">–ù–∞—á–∞—Ç—å</button>
  <button id="wrongOnlyBtn" disabled>–û—à–∏–±–æ—á–Ω—ã–µ ‚Üí –Ω–æ–≤—ã–π –ø—Ä–æ–≥–æ–Ω</button>
  <span class="pill">–®–∞–≥: <span id="stepInfo">‚Äî/‚Äî</span></span>
  <span class="pill">–û—à–∏–±–æ–∫: <span id="wrongCount">0</span></span>
</div>

<div class="spacer"></div>

<div class="panel">
  <div id="question">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</div>
  <textarea id="answerInput" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..."></textarea>

  <div class="row">
    <button id="checkBtn" disabled>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
    <button id="markRightBtn" disabled>–í–µ—Ä–Ω–æ</button>
    <button id="markWrongBtn" disabled>–ù–µ–≤–µ—Ä–Ω–æ</button>
  </div>

  <div class="spacer"></div>
  <div id="correctBox"></div>

  <div class="spacer"></div>
  <div class="row">
    <button id="prevBtn" disabled>–ù–∞–∑–∞–¥</button>
    <button id="nextBtn" disabled>–í–ø–µ—Ä—ë–¥</button>
  </div>
</div>

<script>
// –¢–ï–ú–ê (—Å–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è)
const body=document.body;
if(localStorage.getItem("theme")==="light") body.classList.add("light");
document.getElementById("themeToggle").onclick=()=>{
  body.classList.toggle("light");
  localStorage.setItem("theme", body.classList.contains("light")?"light":"dark");
};

// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
let QA=[];
let order=[];
let idx=0;
let wrongSet=new Set();

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–µ–º
async function loadTopicList(){
  const resp = await fetch("topics_index.json");
  const topics = await resp.json();

  const sel=document.getElementById("topicSelect");
  sel.innerHTML="";

  topics.forEach(t=>{
    const opt=document.createElement("option");
    opt.value=t.file;
    opt.textContent=t.title;
    sel.appendChild(opt);
  });

  sel.onchange = ()=> loadTopic(sel.value);
  loadTopic(sel.value);
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–µ–º—É (.json)
async function loadTopic(filename){
  wrongSet.clear();
  idx=0;

  const resp = await fetch("topics/"+filename);
  const data = await resp.json();

  QA = data.questions;

  document.getElementById("rangeStart").value = 1;
  document.getElementById("rangeEnd").value = QA.length;
  document.getElementById("question").textContent = "–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª";
  document.getElementById("correctBox").style.display="none";
  updateButtons();
}

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞
function buildOrder(start, end){
  order = [];
  for(let i=start;i<end;i++) order.push(i);
  if(document.getElementById("shuffle").checked)
    order.sort(()=>Math.random()-0.5);
  idx=0;
}

// –í—ã–≤–æ–¥ —à–∞–≥–∞
function showStep(){
  document.getElementById("stepInfo").textContent =
    (order.length ? idx+1 : 0)+"/"+order.length;
  document.getElementById("wrongCount").textContent = wrongSet.size;
}

// –í—ã–≤–æ–¥ –≤–æ–ø—Ä–æ—Å–∞
function showQA(){
  if(!order.length){
    document.getElementById("question").textContent="–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª";
    updateButtons();
    return;
  }

  const q=QA[order[idx]].q;
  document.getElementById("question").textContent=q;

  document.getElementById("answerInput").value="";
  const box=document.getElementById("correctBox");
  box.style.display="none";
  box.textContent="";

  updateButtons();
  showStep();
}

// –ü–æ–∫–∞–∑ –æ—Ç–≤–µ—Ç–∞
function showAnswer(){
  const a=QA[order[idx]].a;
  const box=document.getElementById("correctBox");
  box.textContent="–≠—Ç–∞–ª–æ–Ω:\n"+a;
  box.style.display="block";

  document.getElementById("markRightBtn").disabled=false;
  document.getElementById("markWrongBtn").disabled=false;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
function updateButtons(){
  const state = order.length>0;
  document.getElementById("checkBtn").disabled = !state;
  document.getElementById("showAnswerBtn")?.disabled = !state;

  document.getElementById("prevBtn").disabled = !(state && idx>0);
  document.getElementById("nextBtn").disabled = !(state && idx<order.length-1);

  document.getElementById("markRightBtn").disabled = true;
  document.getElementById("markWrongBtn").disabled = true;

  document.getElementById("wrongOnlyBtn").disabled = wrongSet.size===0;
}

// –ö–ù–û–ü–ö–ò
document.getElementById("startBtn").onclick = ()=>{
  const start = Math.max(1, parseInt(rangeStart.value||1)) - 1;
  const end = Math.min(QA.length, parseInt(rangeEnd.value||QA.length));
  if(start>=end) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω.");

  buildOrder(start,end);
  showQA();
};

document.getElementById("wrongOnlyBtn").onclick = ()=>{
  if(!wrongSet.size) return;
  order = Array.from(wrongSet);
  if(shuffle.checked) order.sort(()=>Math.random()-0.5);
  idx=0;
  showQA();
};

document.getElementById("checkBtn").onclick = showAnswer;
document.getElementById("markRightBtn").onclick = ()=>{
  wrongSet.delete(order[idx]);
  if(idx<order.length-1){idx++;showQA();} else showStep();
};
document.getElementById("markWrongBtn").onclick = ()=>{
  wrongSet.add(order[idx]);
  if(idx<order.length-1){idx++;showQA();} else showStep();
};
document.getElementById("nextBtn").onclick = ()=>{if(idx<order.length-1){idx++;showQA();}};
document.getElementById("prevBtn").onclick = ()=>{if(idx>0){idx--;showQA();}};

// –°–¢–ê–†–¢
loadTopicList();
</script>

</body>
</html>
