<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–¢–µ—Å—Ç-—Ç—Ä–µ–Ω–∞–∂—ë—Ä (—Ç–µ–º—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root {
    --gap: 10px;
    --bg-color: #1e1e1e;
    --panel-color: #262626;
    --text-color: #eaeaea;
    --muted: #bdbdbd;
    --button-bg: #323232;
    --button-hover: #3c3c3c;
    --button-text: #ffffff;
    --accent: #6ba4ff;
    --border-color: #444;
  }
  .light {
    --bg-color: #ffffff;
    --panel-color: #f4f4f4;
    --text-color: #1e1e1e;
    --muted: #555;
    --button-bg: #e0e0e0;
    --button-hover: #d5d5d5;
    --button-text: #000;
    --accent: #0066cc;
    --border-color: #ccc;
  }
  body{
    font-family: system-ui, sans-serif;
    margin:20px;
    background:var(--bg-color);
    color:var(--text-color);
  }
  h2{margin:0 0 10px}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
  .panel{border:1px solid var(--border-color);border-radius:12px;padding:12px;background:var(--panel-color)}
  #question{white-space:pre-line;font-weight:600;margin:10px 0}
  #answerInput{width:100%;min-height:110px;padding:10px;font-size:16px;background:var(--panel-color);color:var(--text-color);border:1px solid var(--border-color);border-radius:8px}
  button{padding:8px 12px;border:none;border-radius:10px;cursor:pointer;background:var(--button-bg);color:var(--button-text)}
  button:hover:not(:disabled){background:var(--button-hover)}
  button:disabled{opacity:.45;cursor:not-allowed}
  .pill{padding:4px 8px;border-radius:999px;background:var(--panel-color);color:var(--muted);border:1px solid var(--border-color)}
  .spacer{height:8px}
  #correctBox{white-space:pre-line;padding:10px;background:var(--panel-color);border:1px solid var(--border-color);border-radius:8px;color:var(--accent);display:none}
  /* –û–¥–∏–Ω–∞–∫–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è select –∏ input[type=number] */
select,
input[type=number] {
  background: var(--panel-color);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 6px;
}
  #themeToggle{margin-left:auto}
</style>
</head>
<body>

<div class="row">
  <h2>–¢–µ—Å—Ç-—Ç—Ä–µ–Ω–∞–∂—ë—Ä</h2>
  <button id="themeToggle">üåô/‚òÄÔ∏è</button>
</div>

<div class="panel row">
  <label>–¢–µ–º–∞:
    <select id="topicSelect"></select>
  </label>
</div>

<div class="spacer"></div>

<div class="panel row">
  <label>–°: <input id="rangeStart" type="number" min="1" value="1"></label>
  <label>–ü–æ: <input id="rangeEnd" type="number" min="1" value="1"></label>
  <label><input id="shuffle" type="checkbox"> –ü–µ—Ä–µ–º–µ—à–∞—Ç—å</label>
  <label><input id="hideVariants" type="checkbox"> –°–∫—Ä—ã—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</label>
  <button id="startBtn">–ù–∞—á–∞—Ç—å</button>
  <button id="wrongOnlyBtn" disabled>–û—à–∏–±–æ—á–Ω—ã–µ ‚Üí –Ω–æ–≤—ã–π –ø—Ä–æ–≥–æ–Ω</button>
  <span class="pill">–®–∞–≥: <span id="stepInfo">‚Äî/‚Äî</span></span>
  <span class="pill">–û—à–∏–±–æ–∫: <span id="wrongCount">0</span></span>
</div>

<div class="spacer"></div>

<div class="panel">
  <div id="question">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</div>
  <textarea id="answerInput" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..."></textarea>
  <div id="answerContainer"></div>


  <div class="row">
    <button id="checkBtn" disabled>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
    <button id="markRightBtn" disabled>–í–µ—Ä–Ω–æ</button>
    <button id="markWrongBtn" disabled>–ù–µ–≤–µ—Ä–Ω–æ</button>
  </div>

  <div class="spacer"></div>
  <div id="correctBox"></div>

  <div class="spacer"></div>
  <div class="row">
    <button id="prevBtn" disabled>–ù–∞–∑–∞–¥</button>
    <button id="nextBtn" disabled>–í–ø–µ—Ä—ë–¥</button>
  </div>
</div>

<script>
"use strict";
/* ========== THEME (dark/light) ========== */
const body = document.body;
const themeToggle = document.getElementById("themeToggle");
if (localStorage.getItem("theme") === "light") body.classList.add("light");
themeToggle.onclick = () => {
  body.classList.toggle("light");
  localStorage.setItem("theme", body.classList.contains("light") ? "light" : "dark");
};

/* ========== DOM REFS ========== */
const topicSelect = document.getElementById("topicSelect");
const rangeStartElem = document.getElementById("rangeStart");
const rangeEndElem = document.getElementById("rangeEnd");
const shuffleElem = document.getElementById("shuffle");

const startBtn = document.getElementById("startBtn");
const wrongOnlyBtn = document.getElementById("wrongOnlyBtn");
const checkBtn = document.getElementById("checkBtn");
const markRightBtn = document.getElementById("markRightBtn");
const markWrongBtn = document.getElementById("markWrongBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");

const questionBox = document.getElementById("question");
const answerInput = document.getElementById("answerInput");
const correctBox = document.getElementById("correctBox");
const answerContainer = document.getElementById("answerContainer");
const stepInfo = document.getElementById("stepInfo");
const wrongCount = document.getElementById("wrongCount");
const hideVariantsElem = document.getElementById("hideVariants");
/* ========== STATE ========== */
let QA = [];
let order = [];
let idx = 0;
let wrongSet = new Set();

hideVariantsElem.onchange = () => {
  showQA();
};
/* ========== LOAD TOPIC LIST ========== */
async function loadTopicList(){
  try {
    const resp = await fetch("topics_index.json");
    if (!resp.ok) throw new Error("–ù–µ—Ç topics_index.json");
    const topics = await resp.json();

    topicSelect.innerHTML = "";
    topics.forEach((t, i) => {
      const opt = document.createElement("option");
      opt.value = t.file;
      opt.textContent = t.title || t.file;
      topicSelect.appendChild(opt);
    });

    // when user changes selection
    topicSelect.onchange = () => loadTopic(topicSelect.value);

    // initialize with first option (if exists)
    if(topicSelect.options.length > 0){
      topicSelect.selectedIndex = 0;
      loadTopic(topicSelect.value);
    } else {
      // no topics found
      questionBox.textContent = "–¢–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ topics_index.json –∏ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É topics/";
      updateButtons();
    }
  } catch (err) {
    console.error(err);
    questionBox.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ–º: " + err.message;
    topicSelect.innerHTML = "";
    updateButtons();
  }
}

/* ========== LOAD TOPIC (JSON) ========== */
async function loadTopic(filename){
  wrongSet.clear();
  idx = 0;
  order = [];

  if(!filename){
    QA = [];
    questionBox.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É";
    correctBox.style.display = "none";
    updateButtons();
    return;
  }

  try {
    const resp = await fetch("topics/" + filename);
    if (!resp.ok) throw new Error("–§–∞–π–ª —Ç–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω: " + filename);
    const data = await resp.json();

    QA = Array.isArray(data)
      ? data
      : Array.isArray(data.questions)
        ? data.questions
        : [];

    // safety: if QA is not array, try common shapes
    if(!Array.isArray(QA)) QA = [];

    rangeStartElem.value = 1;
    rangeEndElem.value = QA.length || 1;
    questionBox.textContent = "–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª";
    correctBox.style.display = "none";
    correctBox.textContent = "";
    updateButtons();
  } catch (err) {
    console.error(err);
    QA = [];
    questionBox.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ–º—ã: " + err.message;
    correctBox.style.display = "none";
    updateButtons();
  }
}

/* ========== ORDER BUILD & NAV ========== */
function buildOrder(start, end){
  order = [];
  // clamp
  start = Math.max(0, Math.min(start, QA.length - 1));
  end = Math.max(0, Math.min(end, QA.length));
  for(let i = start; i < end; i++) order.push(i);
  if(shuffleElem.checked) order.sort(() => Math.random() - 0.5);
  idx = 0;
}

function showStep(){
  stepInfo.textContent = (order.length ? (idx + 1) : 0) + "/" + (order.length || 0);
  wrongCount.textContent = wrongSet.size;
}
  
function normalizeQuestion(text) {
  if (!hideVariantsElem.checked) return text;

  // —É–¥–∞–ª—è–µ–º (—á–∏—Å–ª–æ) –¢–û–õ–¨–ö–û –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏
  return text.replace(/\s*\(\d+\)\s*$/, "");
}
  
/* ========== SHOW QA ========== */
function showQA(){
  if(!order.length){
    questionBox.textContent = "–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª";
    answerInput.value = "";
    answerContainer.innerHTML = "";
    answerInput.style.display = "none";
    correctBox.style.display = "none";
    correctBox.textContent = "";
    updateButtons();
    showStep();
    return;
  }

  const currentIndex = order[idx];
  const current = QA[currentIndex];
  if (!current) return;

  answerContainer.innerHTML = "";
  answerInput.style.display = "none";
  const qText = QA[currentIndex]?.q ?? ("–í–æ–ø—Ä–æ—Å #" + (currentIndex + 1));
  switch (current.type) {

  case "single":
  case "multi":

    current.options.forEach((opt, i) => {

      const inputType = current.type === "single" ? "radio" : "checkbox";

      const label = document.createElement("label");
      label.innerHTML = `
        <input type="${inputType}" name="answer" value="${i}">
        ${opt}
      `;

      answerContainer.appendChild(label);
      answerContainer.appendChild(document.createElement("br"));
    });

    break;


  case "matching":

    const header = document.createElement("div");
    header.innerHTML = `
      <strong>${current.left_title || "–õ–µ–≤–∞—è –≥—Ä—É–ø–ø–∞"}</strong>
      &nbsp;&nbsp;&nbsp;&nbsp;
      <strong>${current.right_title || "–ü—Ä–∞–≤–∞—è –≥—Ä—É–ø–ø–∞"}</strong>
    `;
    answerContainer.appendChild(header);
    answerContainer.appendChild(document.createElement("hr"));

    current.left.forEach((item, i) => {

      const select = document.createElement("select");
      select.dataset.index = i;

      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "-- –≤—ã–±–µ—Ä–∏—Ç–µ --";
      select.appendChild(defaultOption);

      current.right.forEach((option, j) => {
        const opt = document.createElement("option");
        opt.value = j;
        opt.textContent = option;
        select.appendChild(opt);
      });

      const row = document.createElement("div");
      row.innerHTML = `<strong>${item}</strong> ‚Üí `;
      row.appendChild(select);

      answerContainer.appendChild(row);
    });

    break;


  case "fill_each":

    current.items.forEach((item, i) => {

      const input = document.createElement("input");
      input.type = "text";
      input.dataset.index = i;

      const row = document.createElement("div");
      row.textContent = item + " ";
      row.appendChild(input);

      answerContainer.appendChild(row);
    });

    break;


  case "sequence":

    current.items.forEach((item, i) => {

      const input = document.createElement("input");
      input.type = "number";
      input.min = 1;
      input.max = current.items.length;
      input.dataset.index = i;

      const row = document.createElement("div");
      row.textContent = item + " ‚Äî –ø–æ—Ä—è–¥–æ–∫: ";
      row.appendChild(input);

      answerContainer.appendChild(row);
    });

    break;


  case "assertion":

    const block = document.createElement("div");
    block.innerHTML = `
      <p>1) ${current.statement1}</p>
      <p>2) ${current.statement2}</p>
    `;
    answerContainer.appendChild(block);

    const variants = [
      "–û–±–∞ –≤–µ—Ä–Ω—ã, –µ—Å—Ç—å —Å–≤—è–∑—å",
      "–û–±–∞ –≤–µ—Ä–Ω—ã, —Å–≤—è–∑–∏ –Ω–µ—Ç",
      "–í–µ—Ä–Ω–æ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ",
      "–í–µ—Ä–Ω–æ —Ç–æ–ª—å–∫–æ –≤—Ç–æ—Ä–æ–µ",
      "–û–±–∞ –Ω–µ–≤–µ—Ä–Ω—ã"
    ];

    variants.forEach((text, i) => {

      const label = document.createElement("label");
      label.innerHTML = `
        <input type="radio" name="assertion" value="${i}">
        ${text}
      `;

      answerContainer.appendChild(label);
      answerContainer.appendChild(document.createElement("br"));
    });

    break;


  default:
    answerInput.style.display = "block";
}

  questionBox.textContent = normalizeQuestion(qText);
  answerInput.value = "";
  correctBox.style.display = "none";
  correctBox.textContent = "";

  updateButtons();
  showStep();
}

/* ========== SHOW ANSWER ========== */
/* ====== –ù–∞–¥—ë–∂–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ/—Å–∫—Ä—ã—Ç–∏–µ –æ—Ç–≤–µ—Ç–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ ====== */

function showAnswer() {
  if (!order.length) return;
  const current = QA[order[idx]];
  if (!current) return;
  const aText = QA[order[idx]]?.a ?? "(—ç—Ç–∞–ª–æ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)";
  if (current.type === "matching") {

  let correct = true;

  document.querySelectorAll("select").forEach(select => {
    const i = select.dataset.index;
    if (parseInt(select.value) !== current.correct[i]) {
      correct = false;
    }
  });

  alert(correct ? "–í–µ—Ä–Ω–æ" : "–ù–µ–≤–µ—Ä–Ω–æ");
  return;
}


if (current.type === "fill_each") {

  let correct = true;

  document.querySelectorAll("input[type='text']").forEach(input => {
    const i = input.dataset.index;

    if (input.value.trim().toLowerCase() !==
        current.answers[i].toLowerCase()) {
      correct = false;
    }
  });

  alert(correct ? "–í–µ—Ä–Ω–æ" : "–ù–µ–≤–µ—Ä–Ω–æ");
  return;
}


if (current.type === "sequence") {

  let correct = true;

  document.querySelectorAll("input[type='number']").forEach(input => {
    const i = input.dataset.index;

    if (parseInt(input.value) - 1 !==
        current.correct_order[i]) {
      correct = false;
    }
  });

  alert(correct ? "–í–µ—Ä–Ω–æ" : "–ù–µ–≤–µ—Ä–Ω–æ");
  return;
}


if (current.type === "assertion") {

  const selected = document.querySelector("input[name='assertion']:checked");
  if (!selected) {
    alert("–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç");
    return;
  }

  alert(parseInt(selected.value) === current.correct
    ? "–í–µ—Ä–Ω–æ"
    : "–ù–µ–≤–µ—Ä–Ω–æ");

  return;
}

  correctBox.textContent = "–≠—Ç–∞–ª–æ–Ω:\n" + aText;
  correctBox.style.display = "block";
  // –≤–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ–º–µ—Ç–∫–∏ –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞
  markRightBtn.disabled = false;
  markWrongBtn.disabled = false;
  // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª –¥–µ–π—Å—Ç–≤–∏–µ
  checkBtn.textContent = "–°–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç";
}

function hideAnswer() {
  correctBox.style.display = "none";
  correctBox.textContent = "";
  // –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–º–µ—Ç–∫–∏
  markRightBtn.disabled = true;
  markWrongBtn.disabled = true;
  checkBtn.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç";
}

function isAnswerVisible() {
  return window.getComputedStyle(correctBox).display !== "none";
}

function toggleAnswer() {
  if (isAnswerVisible()) {
    hideAnswer();
  } else {
    showAnswer();
  }
}

// –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∫ toggle (–∑–∞–º–µ–Ω–∏—Ç—å –ª—é–±—É—é —Å—Ç–∞—Ä—É—é –ø—Ä–∏–≤—è–∑–∫—É showAnswer)
checkBtn.onclick = toggleAnswer;

/* ========== UPDATE BUTTONS ========== */
function updateButtons(){
  const hasOrder = order.length > 0;
  checkBtn.disabled = !hasOrder;
  markRightBtn.disabled = true;
  markWrongBtn.disabled = true;

  prevBtn.disabled = !(hasOrder && idx > 0);
  nextBtn.disabled = !(hasOrder && idx < order.length - 1);

  wrongOnlyBtn.disabled = wrongSet.size === 0;

  // also disable start if no QA loaded
  startBtn.disabled = QA.length === 0;
}

/* ========== BUTTON HANDLERS ========== */
startBtn.onclick = () => {
  const start = Math.max(1, parseInt(rangeStartElem.value || 1)) - 1;
  let end = Math.min(QA.length, parseInt(rangeEndElem.value || QA.length));
  if (isNaN(start) || isNaN(end) || start < 0 || end <= start) {
    return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ '–°' < '–ü–æ' –∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.");
  }

  buildOrder(start, end);
  showQA();
};

wrongOnlyBtn.onclick = () => {
  if (!wrongSet.size) return;
  order = Array.from(wrongSet);
  if (shuffleElem.checked) order.sort(() => Math.random() - 0.5);
  idx = 0;
  showQA();
};


markRightBtn.onclick = () => {
  wrongSet.delete(order[idx]);
  if (idx < order.length - 1) { idx++; showQA(); } else { showStep(); updateButtons(); }
};
markWrongBtn.onclick = () => {
  wrongSet.add(order[idx]);
  if (idx < order.length - 1) { idx++; showQA(); } else { showStep(); updateButtons(); }
};

nextBtn.onclick = () => { if (idx < order.length - 1) { idx++; showQA(); } };
prevBtn.onclick = () => { if (idx > 0) { idx--; showQA(); } };

/* ========== INIT ========== */
loadTopicList();
/* ========== KEYBOARD SHORTCUTS (fixed toggle) ========== */
document.addEventListener("keydown", (e) => {
  // Enter –≤–Ω—É—Ç—Ä–∏ textarea: –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç (Shift+Enter –æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å)
  if (document.activeElement === answerInput) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      toggleAnswer();
    }
    return;
  }

  // –û–±—â–∏–µ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
  if (e.key === "Enter") {
    e.preventDefault();
    toggleAnswer();
  } else if (e.key === "ArrowLeft") {
    if (!prevBtn.disabled) prevBtn.click();
  } else if (e.key === "ArrowRight") {
    if (!nextBtn.disabled) nextBtn.click();
  }
});
</script>

</body>
</html>
