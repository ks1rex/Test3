<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–¢–µ—Å—Ç-—Ç—Ä–µ–Ω–∞–∂—ë—Ä (—Ç–µ–º—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root {
    --gap: 10px;
    --bg-color: #1e1e1e;
    --panel-color: #262626;
    --text-color: #eaeaea;
    --muted: #bdbdbd;
    --button-bg: #323232;
    --button-hover: #3c3c3c;
    --button-text: #ffffff;
    --accent: #6ba4ff;
    --border-color: #444;
  }
  .light {
    --bg-color: #ffffff;
    --panel-color: #f4f4f4;
    --text-color: #1e1e1e;
    --muted: #555;
    --button-bg: #e0e0e0;
    --button-hover: #d5d5d5;
    --button-text: #000;
    --accent: #0066cc;
    --border-color: #ccc;
  }
  body{
    font-family: system-ui, sans-serif;
    margin:20px;
    background:var(--bg-color);
    color:var(--text-color);
  }
  h2{margin:0 0 10px}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
  .panel{border:1px solid var(--border-color);border-radius:12px;padding:12px;background:var(--panel-color)}
  #question{white-space:pre-line;font-weight:600;margin:10px 0}
  #answerInput{width:100%;min-height:110px;padding:10px;font-size:16px;background:var(--panel-color);color:var(--text-color);border:1px solid var(--border-color);border-radius:8px}
  button{padding:8px 12px;border:none;border-radius:10px;cursor:pointer;background:var(--button-bg);color:var(--button-text)}
  button:hover:not(:disabled){background:var(--button-hover)}
  button:disabled{opacity:.45;cursor:not-allowed}
  .pill{padding:4px 8px;border-radius:999px;background:var(--panel-color);color:var(--muted);border:1px solid var(--border-color)}
  .spacer{height:8px}
  #correctBox{white-space:pre-line;padding:10px;background:var(--panel-color);border:1px solid var(--border-color);border-radius:8px;color:var(--accent);display:none}
  select{background:var(--panel-color);color:var(--text-color);border:1px solid var(--border-color);border-radius:8px;padding:6px}
  #themeToggle{margin-left:auto}
</style>
</head>
<body>

<div class="row">
  <h2>–¢–µ—Å—Ç-—Ç—Ä–µ–Ω–∞–∂—ë—Ä</h2>
  <button id="themeToggle">üåô/‚òÄÔ∏è</button>
</div>

<div class="panel row">
  <label>–¢–µ–º–∞:
    <select id="topicSelect"></select>
  </label>
</div>

<div class="spacer"></div>

<div class="panel row">
  <label>–°: <input id="rangeStart" type="number" min="1" value="1"></label>
  <label>–ü–æ: <input id="rangeEnd" type="number" min="1" value="1"></label>
  <label><input id="shuffle" type="checkbox"> –ü–µ—Ä–µ–º–µ—à–∞—Ç—å</label>
  <button id="startBtn">–ù–∞—á–∞—Ç—å</button>
  <button id="wrongOnlyBtn" disabled>–û—à–∏–±–æ—á–Ω—ã–µ ‚Üí –Ω–æ–≤—ã–π –ø—Ä–æ–≥–æ–Ω</button>
  <span class="pill">–®–∞–≥: <span id="stepInfo">‚Äî/‚Äî</span></span>
  <span class="pill">–û—à–∏–±–æ–∫: <span id="wrongCount">0</span></span>
</div>

<div class="spacer"></div>

<div class="panel">
  <div id="question">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</div>
  <textarea id="answerInput" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..."></textarea>

  <div class="row">
    <button id="checkBtn" disabled>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
    <button id="markRightBtn" disabled>–í–µ—Ä–Ω–æ</button>
    <button id="markWrongBtn" disabled>–ù–µ–≤–µ—Ä–Ω–æ</button>
  </div>

  <div class="spacer"></div>
  <div id="correctBox"></div>

  <div class="spacer"></div>
  <div class="row">
    <button id="prevBtn" disabled>–ù–∞–∑–∞–¥</button>
    <button id="nextBtn" disabled>–í–ø–µ—Ä—ë–¥</button>
  </div>
</div>

<script>
/* ========== THEME (dark/light) ========== */
const body = document.body;
const themeToggle = document.getElementById("themeToggle");
if (localStorage.getItem("theme") === "light") body.classList.add("light");
themeToggle.onclick = () => {
  body.classList.toggle("light");
  localStorage.setItem("theme", body.classList.contains("light") ? "light" : "dark");
};

/* ========== DOM REFS ========== */
const topicSelect = document.getElementById("topicSelect");
const rangeStartElem = document.getElementById("rangeStart");
const rangeEndElem = document.getElementById("rangeEnd");
const shuffleElem = document.getElementById("shuffle");

const startBtn = document.getElementById("startBtn");
const wrongOnlyBtn = document.getElementById("wrongOnlyBtn");
const checkBtn = document.getElementById("checkBtn");
const markRightBtn = document.getElementById("markRightBtn");
const markWrongBtn = document.getElementById("markWrongBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");

const questionBox = document.getElementById("question");
const answerInput = document.getElementById("answerInput");
const correctBox = document.getElementById("correctBox");
const stepInfo = document.getElementById("stepInfo");
const wrongCount = document.getElementById("wrongCount");

/* ========== STATE ========== */
let QA = [];
let order = [];
let idx = 0;
let wrongSet = new Set();

/* ========== LOAD TOPIC LIST ========== */
async function loadTopicList(){
  try {
    const resp = await fetch("topics_index.json");
    if (!resp.ok) throw new Error("–ù–µ—Ç topics_index.json");
    const topics = await resp.json();

    topicSelect.innerHTML = "";
    topics.forEach((t, i) => {
      const opt = document.createElement("option");
      opt.value = t.file;
      opt.textContent = t.title || t.file;
      topicSelect.appendChild(opt);
    });

    // when user changes selection
    topicSelect.onchange = () => loadTopic(topicSelect.value);

    // initialize with first option (if exists)
    if(topicSelect.options.length > 0){
      topicSelect.selectedIndex = 0;
      loadTopic(topicSelect.value);
    } else {
      // no topics found
      questionBox.textContent = "–¢–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ topics_index.json –∏ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É topics/";
      updateButtons();
    }
  } catch (err) {
    console.error(err);
    questionBox.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ–º: " + err.message;
    topicSelect.innerHTML = "";
    updateButtons();
  }
}

/* ========== LOAD TOPIC (JSON) ========== */
async function loadTopic(filename){
  wrongSet.clear();
  idx = 0;
  order = [];

  if(!filename){
    QA = [];
    questionBox.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É";
    correctBox.style.display = "none";
    updateButtons();
    return;
  }

  try {
    const resp = await fetch("topics/" + filename);
    if (!resp.ok) throw new Error("–§–∞–π–ª —Ç–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω: " + filename);
    const data = await resp.json();

    QA = Array.isArray(data.questions) ? data.questions : (data || []).questions || [];

    // safety: if QA is not array, try common shapes
    if(!Array.isArray(QA)) QA = [];

    rangeStartElem.value = 1;
    rangeEndElem.value = QA.length || 1;
    questionBox.textContent = "–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª";
    correctBox.style.display = "none";
    correctBox.textContent = "";
    updateButtons();
  } catch (err) {
    console.error(err);
    QA = [];
    questionBox.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ–º—ã: " + err.message;
    correctBox.style.display = "none";
    updateButtons();
  }
}

/* ========== ORDER BUILD & NAV ========== */
function buildOrder(start, end){
  order = [];
  // clamp
  start = Math.max(0, Math.min(start, QA.length - 1));
  end = Math.max(0, Math.min(end, QA.length));
  for(let i = start; i < end; i++) order.push(i);
  if(shuffleElem.checked) order.sort(() => Math.random() - 0.5);
  idx = 0;
}

function showStep(){
  stepInfo.textContent = (order.length ? (idx + 1) : 0) + "/" + (order.length || 0);
  wrongCount.textContent = wrongSet.size;
}

/* ========== SHOW QA ========== */
function showQA(){
  if(!order.length){
    questionBox.textContent = "–ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª";
    answerInput.value = "";
    correctBox.style.display = "none";
    correctBox.textContent = "";
    updateButtons();
    showStep();
    return;
  }

  const currentIndex = order[idx];
  const qText = QA[currentIndex]?.q ?? ("–í–æ–ø—Ä–æ—Å #" + (currentIndex + 1));
  questionBox.textContent = qText;
  answerInput.value = "";
  correctBox.style.display = "none";
  correctBox.textContent = "";

  updateButtons();
  showStep();
}

/* ========== SHOW ANSWER ========== */
function showAnswer(){
  if(!order.length) return;
  const aText = QA[order[idx]]?.a ?? "(—ç—Ç–∞–ª–æ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)";
  correctBox.textContent = "–≠—Ç–∞–ª–æ–Ω:\n" + aText;
  correctBox.style.display = "block";

  markRightBtn.disabled = false;
  markWrongBtn.disabled = false;
}

/* ========== UPDATE BUTTONS ========== */
function updateButtons(){
  const hasOrder = order.length > 0;
  checkBtn.disabled = !hasOrder;
  markRightBtn.disabled = true;
  markWrongBtn.disabled = true;

  prevBtn.disabled = !(hasOrder && idx > 0);
  nextBtn.disabled = !(hasOrder && idx < order.length - 1);

  wrongOnlyBtn.disabled = wrongSet.size === 0;

  // also disable start if no QA loaded
  startBtn.disabled = QA.length === 0;
}

/* ========== BUTTON HANDLERS ========== */
startBtn.onclick = () => {
  const start = Math.max(1, parseInt(rangeStartElem.value || 1)) - 1;
  let end = Math.min(QA.length, parseInt(rangeEndElem.value || QA.length));
  if (isNaN(start) || isNaN(end) || start < 0 || end <= start) {
    return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ '–°' < '–ü–æ' –∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.");
  }

  buildOrder(start, end);
  showQA();
};

wrongOnlyBtn.onclick = () => {
  if (!wrongSet.size) return;
  order = Array.from(wrongSet);
  if (shuffleElem.checked) order.sort(() => Math.random() - 0.5);
  idx = 0;
  showQA();
};

checkBtn.onclick = showAnswer;

markRightBtn.onclick = () => {
  wrongSet.delete(order[idx]);
  if (idx < order.length - 1) { idx++; showQA(); } else { showStep(); updateButtons(); }
};
markWrongBtn.onclick = () => {
  wrongSet.add(order[idx]);
  if (idx < order.length - 1) { idx++; showQA(); } else { showStep(); updateButtons(); }
};

nextBtn.onclick = () => { if (idx < order.length - 1) { idx++; showQA(); } };
prevBtn.onclick = () => { if (idx > 0) { idx--; showQA(); } };

/* ========== INIT ========== */
loadTopicList();
  /* ========== KEYBOARD SHORTCUTS ========== */
document.addEventListener("keydown", (e) => {

  // –ï—Å–ª–∏ –≤ textarea ‚Äî –Ω–µ –ª–æ–º–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
  if (document.activeElement === answerInput) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault(); // –±–ª–æ–∫–∏—Ä—É–µ–º –æ–±—ã—á–Ω—ã–π Enter
      toggleAnswer();
    }
    return;
  }

  // Enter ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç
  if (e.key === "Enter") {
    e.preventDefault();
    toggleAnswer();
  }

  // ‚Üê –Ω–∞–∑–∞–¥
  if (e.key === "ArrowLeft") {
    if (!prevBtn.disabled) prevBtn.click();
  }

  // ‚Üí –≤–ø–µ—Ä—ë–¥
  if (e.key === "ArrowRight") {
    if (!nextBtn.disabled) nextBtn.click();
  }
});

/* ========== ANSWER TOGGLE ========== */
function toggleAnswer() {
  if (correctBox.style.display === "block") {
    // —Å–∫—Ä—ã—Ç—å
    correctBox.style.display = "none";
    correctBox.textContent = "";
    markRightBtn.disabled = true;
    markWrongBtn.disabled = true;
  } else {
    // –ø–æ–∫–∞–∑–∞—Ç—å
    showAnswer();
  }
}
</script>

</body>
</html>
